---
phase: 02-location-discovery
plan: 01
type: execute
---

<objective>
Extend location types, expand mock data to more cities, add geolocation utilities, and create location context provider.

Purpose: Build the location service layer that all location-aware features depend on.
Output: Extended types, 6+ cities with areas, useGeolocation hook, LocationProvider context.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@CLAUDE.md

**Depends on:** Phase 1 complete

**From Phase 1 (01-03):**
@src/types/location.ts - EXISTING: City, LocationArea, UserLocation types
@src/lib/mock-data/locations.ts - EXISTING: 3 Texas cities, 7 areas
@src/lib/mock-data/utils.ts - EXISTING: getActiveCities, getAreasForCity, getCityByName

**Key Phase 1 decisions:**
- City type has `isActive: boolean` field
- LocationArea uses `radiusMiles` (not km)
- UserLocation has simple `source: 'geolocation' | 'ip' | 'manual'`
- All IDs are UUID-style strings matching Supabase conventions

**What this plan adds:**
- LocationState type for context management
- More cities (expand from 3 Texas cities to 6+ major medspa markets)
- findNearestCity and getCityById utilities
- useGeolocation hook for browser API
- LocationContext/Provider for app-wide state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend location types and expand mock data</name>
  <files>src/types/location.ts, src/lib/mock-data/locations.ts, src/lib/mock-data/utils.ts</files>
  <action>
1. Add LocationState type to src/types/location.ts:
   ```typescript
   export interface LocationState {
     current: {
       type: 'detected' | 'selected' | 'default'
       city: City | null
       area: LocationArea | null
       coordinates: { latitude: number; longitude: number } | null
       accuracy: number | null
     }
     isLoading: boolean
     error: string | null
     hasPermission: boolean | null
   }
   ```

2. Expand src/lib/mock-data/locations.ts to add more cities (keep existing Austin, Dallas, Houston):
   - Add: Los Angeles, New York, Miami (major medspa markets)
   - Add 2-3 areas per new city
   - Use same patterns as existing data (isActive: true, radiusMiles for areas)

3. Add to src/lib/mock-data/utils.ts:
   - getCityById(id: string): City | undefined
   - findNearestCity(lat: number, lng: number): City (Haversine distance)
   - DEFAULT_CITY constant (first active city)

4. Export new utilities from src/lib/mock-data/index.ts
  </action>
  <verify>npm run build succeeds, new cities appear in getActiveCities(), findNearestCity returns correct city</verify>
  <done>6+ cities with areas, LocationState type added, findNearestCity utility works</done>
</task>

<task type="auto">
  <name>Task 2: Create useGeolocation hook and LocationContext provider</name>
  <files>src/lib/hooks/useGeolocation.ts, src/lib/context/locationContext.tsx, src/app/layout.tsx</files>
  <action>
1. Create src/lib/hooks/useGeolocation.ts:
   - Wraps browser navigator.geolocation API
   - Returns: coordinates, accuracy, isLoading, error, timestamp
   - Provides: requestLocation() async function, clearLocation(), isSupported boolean
   - Handles permission denied, position unavailable, timeout errors with clear messages

2. Create src/lib/context/locationContext.tsx:
   - Uses LocationState type from @/types
   - Uses mock data utilities: cities, getAreasForCity, findNearestCity, getCityById
   - Uses useGeolocation hook internally
   - Persists selection to localStorage (key: 'costfinders_location')
   - Provides:
     * current location state
     * cities array
     * getAreasForCity(cityId) function
     * detectLocation() - triggers geolocation, finds nearest city
     * selectCity(city) - manual selection
     * selectArea(area | null) - area filter
     * clearSelection() - reset to default
   - Initializes with DEFAULT_CITY from utils

3. Update src/app/layout.tsx:
   - Import LocationProvider
   - Wrap children with LocationProvider inside body
  </action>
  <verify>npm run build succeeds, LocationProvider renders without errors, useLocation hook accessible</verify>
  <done>useGeolocation hook handles browser API, LocationContext provides app-wide location state with persistence</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] LocationState type properly exported from @/types
- [ ] 6+ cities with their areas in mock data
- [ ] findNearestCity returns correct city for given coordinates
- [ ] getCityById returns correct city
- [ ] useGeolocation hook handles all error states
- [ ] LocationContext properly initializes with default location
- [ ] Location persists to localStorage on selection
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 6+ cities with 15+ total areas
- useGeolocation hook fully handles browser Geolocation API
- LocationContext provides: current location, detect, select city/area, clear
- Location persists across page refreshes via localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/02-location-discovery/02-01-SUMMARY.md`
</output>
