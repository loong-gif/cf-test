---
phase: 02-location-discovery
plan: 02
type: execute
---

<objective>
Build location selection UI components for city picker, area filter, and "near me" toggle.

Purpose: Enable users to easily set their location for deal discovery through intuitive UI.
Output: LocationSelector, CityPicker, AreaFilter components and integration with app layout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@CLAUDE.md
@.planning/phases/02-location-discovery/02-01-PLAN.md

**Depends on:** 02-01-PLAN.md (location types, mock data, context)

**UI requirements:**
- City picker dropdown with search
- Area filter as secondary selection within city
- "Near me" toggle to auto-detect location
- Location display in header/navbar
- Glassmorphic styling per design system

**Component architecture:**
- CityPicker, AreaFilter go in components/patterns/ (reusable compositions)
- LocationSelector (combines both) goes in components/features/ (domain logic)
- LocationDisplay (for header) goes in components/layout/

**From Phase 1:**
- Button, Card, Input, Modal components available
- Design tokens defined
- Phosphor icons installed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CityPicker and AreaFilter pattern components</name>
  <files>src/components/patterns/cityPicker.tsx, src/components/patterns/areaFilter.tsx</files>
  <action>
1. Create src/components/patterns/cityPicker.tsx:
   ```tsx
   'use client'

   import { useState, useMemo, useRef, useEffect } from 'react'
   import { MagnifyingGlass, MapPin, CaretDown, Check } from '@phosphor-icons/react'
   import type { City } from '@/types/location'

   interface CityPickerProps {
     cities: City[]
     selectedCity: City | null
     onSelect: (city: City) => void
     placeholder?: string
   }

   export function CityPicker({ cities, selectedCity, onSelect, placeholder = 'Select city...' }: CityPickerProps) {
     const [isOpen, setIsOpen] = useState(false)
     const [search, setSearch] = useState('')
     const containerRef = useRef<HTMLDivElement>(null)
     const inputRef = useRef<HTMLInputElement>(null)

     const filteredCities = useMemo(() => {
       if (!search) return cities
       const query = search.toLowerCase()
       return cities.filter(city =>
         city.name.toLowerCase().includes(query) ||
         city.state.toLowerCase().includes(query) ||
         city.stateCode.toLowerCase().includes(query)
       )
     }, [cities, search])

     // Close on outside click
     useEffect(() => {
       const handleClickOutside = (e: MouseEvent) => {
         if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
           setIsOpen(false)
           setSearch('')
         }
       }
       document.addEventListener('mousedown', handleClickOutside)
       return () => document.removeEventListener('mousedown', handleClickOutside)
     }, [])

     // Focus input when opened
     useEffect(() => {
       if (isOpen && inputRef.current) {
         inputRef.current.focus()
       }
     }, [isOpen])

     const handleSelect = (city: City) => {
       onSelect(city)
       setIsOpen(false)
       setSearch('')
     }

     return (
       <div ref={containerRef} className="relative">
         {/* Trigger Button */}
         <button
           type="button"
           onClick={() => setIsOpen(!isOpen)}
           className={`
             w-full flex items-center justify-between gap-2
             px-4 py-2.5 rounded-xl
             bg-glass-bg backdrop-blur-md
             border border-glass-border
             text-left
             transition-all duration-200
             hover:border-glass-border-hover
             focus:outline-none focus:ring-2 focus:ring-brand-primary/50
             ${isOpen ? 'border-brand-primary/50 ring-2 ring-brand-primary/50' : ''}
           `}
         >
           <span className="flex items-center gap-2">
             <MapPin size={18} className="text-brand-primary" weight="fill" />
             {selectedCity ? (
               <span className="text-text-primary">
                 {selectedCity.name}, {selectedCity.stateCode}
               </span>
             ) : (
               <span className="text-text-muted">{placeholder}</span>
             )}
           </span>
           <CaretDown
             size={16}
             className={`text-text-tertiary transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}
           />
         </button>

         {/* Dropdown */}
         {isOpen && (
           <div className="absolute z-50 w-full mt-2 py-2 bg-bg-secondary backdrop-blur-xl border border-glass-border rounded-xl shadow-elevated">
             {/* Search Input */}
             <div className="px-3 pb-2">
               <div className="relative">
                 <MagnifyingGlass
                   size={16}
                   className="absolute left-3 top-1/2 -translate-y-1/2 text-text-tertiary"
                 />
                 <input
                   ref={inputRef}
                   type="text"
                   value={search}
                   onChange={(e) => setSearch(e.target.value)}
                   placeholder="Search cities..."
                   className="w-full pl-9 pr-4 py-2 bg-glass-bg border border-glass-border rounded-lg text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:border-brand-primary/50"
                 />
               </div>
             </div>

             {/* City List */}
             <div className="max-h-60 overflow-y-auto">
               {filteredCities.length === 0 ? (
                 <div className="px-4 py-3 text-sm text-text-tertiary text-center">
                   No cities found
                 </div>
               ) : (
                 filteredCities.map((city) => (
                   <button
                     key={city.id}
                     type="button"
                     onClick={() => handleSelect(city)}
                     className={`
                       w-full flex items-center justify-between px-4 py-2.5 text-left
                       transition-colors duration-150
                       ${selectedCity?.id === city.id
                         ? 'bg-brand-primary/10 text-brand-primary'
                         : 'text-text-primary hover:bg-glass-bg'
                       }
                     `}
                   >
                     <span>
                       {city.name}, {city.stateCode}
                     </span>
                     {selectedCity?.id === city.id && (
                       <Check size={16} weight="bold" className="text-brand-primary" />
                     )}
                   </button>
                 ))
               )}
             </div>
           </div>
         )}
       </div>
     )
   }
   ```

2. Create src/components/patterns/areaFilter.tsx:
   ```tsx
   'use client'

   import { useState, useRef, useEffect } from 'react'
   import { CaretDown, Check, X } from '@phosphor-icons/react'
   import type { Area } from '@/types/location'

   interface AreaFilterProps {
     areas: Area[]
     selectedArea: Area | null
     onSelect: (area: Area | null) => void
     disabled?: boolean
     placeholder?: string
   }

   export function AreaFilter({
     areas,
     selectedArea,
     onSelect,
     disabled = false,
     placeholder = 'All areas',
   }: AreaFilterProps) {
     const [isOpen, setIsOpen] = useState(false)
     const containerRef = useRef<HTMLDivElement>(null)

     // Close on outside click
     useEffect(() => {
       const handleClickOutside = (e: MouseEvent) => {
         if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
           setIsOpen(false)
         }
       }
       document.addEventListener('mousedown', handleClickOutside)
       return () => document.removeEventListener('mousedown', handleClickOutside)
     }, [])

     const handleSelect = (area: Area | null) => {
       onSelect(area)
       setIsOpen(false)
     }

     if (areas.length === 0) {
       return null
     }

     return (
       <div ref={containerRef} className="relative">
         {/* Trigger Button */}
         <button
           type="button"
           onClick={() => !disabled && setIsOpen(!isOpen)}
           disabled={disabled}
           className={`
             flex items-center gap-2
             px-3 py-1.5 rounded-lg
             text-sm
             border border-glass-border
             transition-all duration-200
             ${disabled
               ? 'opacity-50 cursor-not-allowed bg-glass-bg'
               : 'bg-glass-bg hover:border-glass-border-hover cursor-pointer'
             }
             ${selectedArea ? 'text-text-primary' : 'text-text-secondary'}
             ${isOpen ? 'border-brand-primary/50' : ''}
           `}
         >
           <span>{selectedArea?.name || placeholder}</span>
           {selectedArea ? (
             <button
               type="button"
               onClick={(e) => {
                 e.stopPropagation()
                 onSelect(null)
               }}
               className="p-0.5 rounded hover:bg-glass-bg-hover"
             >
               <X size={12} weight="bold" />
             </button>
           ) : (
             <CaretDown
               size={14}
               className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}
             />
           )}
         </button>

         {/* Dropdown */}
         {isOpen && (
           <div className="absolute z-50 w-48 mt-2 py-1 bg-bg-secondary backdrop-blur-xl border border-glass-border rounded-xl shadow-elevated">
             {/* All Areas Option */}
             <button
               type="button"
               onClick={() => handleSelect(null)}
               className={`
                 w-full flex items-center justify-between px-3 py-2 text-left text-sm
                 transition-colors duration-150
                 ${!selectedArea
                   ? 'bg-brand-primary/10 text-brand-primary'
                   : 'text-text-secondary hover:bg-glass-bg'
                 }
               `}
             >
               <span>All areas</span>
               {!selectedArea && <Check size={14} weight="bold" />}
             </button>

             <div className="h-px bg-glass-border my-1" />

             {/* Area List */}
             {areas.map((area) => (
               <button
                 key={area.id}
                 type="button"
                 onClick={() => handleSelect(area)}
                 className={`
                   w-full flex items-center justify-between px-3 py-2 text-left text-sm
                   transition-colors duration-150
                   ${selectedArea?.id === area.id
                     ? 'bg-brand-primary/10 text-brand-primary'
                     : 'text-text-primary hover:bg-glass-bg'
                   }
                 `}
               >
                 <span>{area.name}</span>
                 {selectedArea?.id === area.id && (
                   <Check size={14} weight="bold" className="text-brand-primary" />
                 )}
               </button>
             ))}
           </div>
         )}
       </div>
     )
   }
   ```
  </action>
  <verify>TypeScript compiles, components render without errors</verify>
  <done>CityPicker with search and dropdown, AreaFilter with clear option</done>
</task>

<task type="auto">
  <name>Task 2: Create LocationSelector feature component with "near me" toggle</name>
  <files>src/components/features/locationSelector.tsx</files>
  <action>
Create src/components/features/locationSelector.tsx that combines CityPicker, AreaFilter, and adds "near me" detection:

```tsx
'use client'

import { useState } from 'react'
import { Crosshair, SpinnerGap, WarningCircle } from '@phosphor-icons/react'
import { CityPicker } from '@/components/patterns/cityPicker'
import { AreaFilter } from '@/components/patterns/areaFilter'
import { useLocation } from '@/lib/context/locationContext'

interface LocationSelectorProps {
  showAreaFilter?: boolean
  compact?: boolean
  onLocationChange?: () => void
}

export function LocationSelector({
  showAreaFilter = true,
  compact = false,
  onLocationChange,
}: LocationSelectorProps) {
  const {
    current,
    isLoading,
    error,
    hasPermission,
    cities,
    getAreasForCity,
    detectLocation,
    selectCity,
    selectArea,
  } = useLocation()

  const [isDetecting, setIsDetecting] = useState(false)

  const handleDetect = async () => {
    setIsDetecting(true)
    try {
      await detectLocation()
      onLocationChange?.()
    } finally {
      setIsDetecting(false)
    }
  }

  const handleCitySelect = (city: typeof cities[0]) => {
    selectCity(city)
    onLocationChange?.()
  }

  const handleAreaSelect = (area: Parameters<typeof selectArea>[0]) => {
    selectArea(area)
    onLocationChange?.()
  }

  const areas = current.city ? getAreasForCity(current.city.id) : []

  return (
    <div className={`flex flex-col gap-3 ${compact ? 'sm:flex-row sm:items-center' : ''}`}>
      {/* Near Me Button */}
      <button
        type="button"
        onClick={handleDetect}
        disabled={isDetecting || isLoading}
        className={`
          flex items-center justify-center gap-2
          px-4 py-2.5 rounded-xl
          text-sm font-medium
          transition-all duration-200
          ${current.type === 'detected'
            ? 'bg-brand-primary text-white'
            : 'bg-glass-bg hover:bg-glass-bg-hover border border-glass-border text-text-primary'
          }
          disabled:opacity-50 disabled:cursor-not-allowed
        `}
      >
        {isDetecting ? (
          <SpinnerGap size={18} className="animate-spin" />
        ) : (
          <Crosshair size={18} weight={current.type === 'detected' ? 'fill' : 'regular'} />
        )}
        <span>Near me</span>
      </button>

      {/* Error/Permission Message */}
      {error && hasPermission === false && (
        <div className="flex items-center gap-2 text-xs text-amber-400">
          <WarningCircle size={14} />
          <span>Location access denied</span>
        </div>
      )}

      {/* Divider */}
      {!compact && (
        <div className="flex items-center gap-3">
          <div className="flex-1 h-px bg-glass-border" />
          <span className="text-xs text-text-muted uppercase tracking-wider">or</span>
          <div className="flex-1 h-px bg-glass-border" />
        </div>
      )}

      {/* City/Area Selection */}
      <div className={`flex gap-2 ${compact ? 'flex-1' : 'flex-col sm:flex-row'}`}>
        <div className={compact ? 'flex-1' : 'flex-1'}>
          <CityPicker
            cities={cities}
            selectedCity={current.city}
            onSelect={handleCitySelect}
          />
        </div>

        {showAreaFilter && current.city && areas.length > 0 && (
          <AreaFilter
            areas={areas}
            selectedArea={current.area}
            onSelect={handleAreaSelect}
          />
        )}
      </div>
    </div>
  )
}
```
  </action>
  <verify>Component renders, "near me" triggers detection, city/area selection works</verify>
  <done>LocationSelector combines all location UI with "near me" button and city/area pickers</done>
</task>

<task type="auto">
  <name>Task 3: Create LocationDisplay for header and integrate provider</name>
  <files>src/components/layout/locationDisplay.tsx, src/app/layout.tsx</files>
  <action>
1. Create src/components/layout/locationDisplay.tsx (compact location indicator for header):
   ```tsx
   'use client'

   import { useState } from 'react'
   import { MapPin, CaretDown } from '@phosphor-icons/react'
   import { useLocation } from '@/lib/context/locationContext'
   import { Modal } from '@/components/ui/modal'
   import { LocationSelector } from '@/components/features/locationSelector'

   export function LocationDisplay() {
     const { current, isLoading } = useLocation()
     const [isModalOpen, setIsModalOpen] = useState(false)

     const displayText = current.city
       ? current.area
         ? `${current.area.name}, ${current.city.name}`
         : `${current.city.name}, ${current.city.stateCode}`
       : 'Set location'

     return (
       <>
         <button
           type="button"
           onClick={() => setIsModalOpen(true)}
           className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-glass-bg hover:bg-glass-bg-hover border border-glass-border transition-all duration-200 text-sm"
         >
           <MapPin
             size={16}
             weight="fill"
             className={current.type === 'detected' ? 'text-brand-primary' : 'text-text-secondary'}
           />
           <span className="text-text-primary max-w-[150px] truncate">
             {isLoading ? 'Detecting...' : displayText}
           </span>
           <CaretDown size={12} className="text-text-tertiary" />
         </button>

         <Modal
           isOpen={isModalOpen}
           onClose={() => setIsModalOpen(false)}
           title="Set your location"
           size="md"
         >
           <div className="space-y-4">
             <p className="text-text-secondary text-sm">
               We'll show you deals from medspas in your area.
             </p>
             <LocationSelector onLocationChange={() => setIsModalOpen(false)} />
           </div>
         </Modal>
       </>
     )
   }
   ```

2. Update src/app/layout.tsx to wrap with LocationProvider:
   - Import LocationProvider from '@/lib/context/locationContext'
   - Wrap the children inside the body with LocationProvider
   - Keep existing providers in correct order

   The layout should have structure like:
   ```tsx
   import { LocationProvider } from '@/lib/context/locationContext'

   // In the body:
   <body className={...}>
     <LocationProvider>
       {children}
     </LocationProvider>
   </body>
   ```

3. Create a simple test page to verify location works at src/app/page.tsx:
   Update the existing page to show the location selector and display:
   ```tsx
   import { LocationDisplay } from '@/components/layout/locationDisplay'
   import { LocationSelector } from '@/components/features/locationSelector'
   import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'

   export default function Home() {
     return (
       <main className="min-h-screen bg-bg-primary p-8">
         <div className="max-w-2xl mx-auto space-y-8">
           {/* Header with LocationDisplay */}
           <div className="flex items-center justify-between">
             <h1 className="text-2xl font-bold text-text-primary">CostFinders</h1>
             <LocationDisplay />
           </div>

           {/* Location Selector Card */}
           <Card variant="glass" padding="lg">
             <CardHeader>
               <CardTitle>Find Deals Near You</CardTitle>
             </CardHeader>
             <CardContent>
               <LocationSelector />
             </CardContent>
           </Card>
         </div>
       </main>
     )
   }
   ```
  </action>
  <verify>Location shows in header, modal opens, selection persists across refresh</verify>
  <done>LocationDisplay in header, LocationProvider in layout, test page shows all location UI</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete location discovery UI with city picker, area filter, and near me detection</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000
    3. Verify header shows "Set location" or detected city
    4. Click location in header - modal should open with:
       - "Near me" button (click to test browser geolocation prompt)
       - City picker dropdown with search (search "New York")
       - Area filter appears when city selected
    5. Select a city (e.g., Los Angeles)
    6. Select an area (e.g., Beverly Hills)
    7. Header should update to show "Beverly Hills, Los Angeles"
    8. Refresh page - location should persist
    9. Test "Near me" - should request permission and detect nearest city
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] CityPicker renders dropdown with search
- [ ] AreaFilter renders when city selected
- [ ] LocationSelector combines all elements with "near me"
- [ ] LocationDisplay shows current location in header
- [ ] Modal opens for location change
- [ ] Location persists in localStorage across page refresh
- [ ] Browser geolocation permission is requested when "near me" clicked
- [ ] Nearest city is found when location detected
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- CityPicker with search, 6 cities available
- AreaFilter shows areas for selected city
- "Near me" button triggers geolocation
- Location persists via localStorage
- Clean glassmorphic UI matching design system
</success_criteria>

<output>
After completion, create `.planning/phases/02-location-discovery/02-02-SUMMARY.md`
</output>
