---
phase: 04-consumer-auth
plan: 03
type: execute
---

<objective>
Create email verification UI flow with mock verification.

Purpose: Build the email verification step that users see after sign-up.
Output: EmailVerification component, integration with auth flow to show verification after sign-up.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/04-consumer-auth/04-01-SUMMARY.md
@.planning/phases/04-consumer-auth/04-02-SUMMARY.md

# Existing patterns:
@src/lib/context/authContext.tsx - Auth context with updateVerificationStatus
@src/components/features/authModal.tsx - AuthModal component
@src/types/consumer.ts - VerificationStatus type

**Tech stack available:** AuthContext, Modal, Input, Button
**Established patterns:** Form validation, modal flows
**Constraining decisions:**
- Mock verification only (no real email sending)
- VerificationStatus: 'unverified' → 'email_verified' → 'phone_verified' → 'fully_verified'
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmailVerification component</name>
  <files>src/components/features/emailVerification.tsx</files>
  <action>
Create 'use client' component for email verification UI:

1. Props interface:
   - email: string (the email to verify)
   - onVerified?: () => void
   - onResendCode?: () => void

2. UI structure (check email screen):
   - Envelope icon (EnvelopeSimple from Phosphor)
   - "Check your email" heading
   - "We sent a verification link to {email}" subtext
   - "Didn't receive the email?" with "Resend" button
   - "Open Email App" button (primary) - mock action, just shows toast/message
   - Small text: "Or enter verification code manually" link

3. Alternative code entry view (toggle on "enter code manually"):
   - 6 digit code input (single Input, placeholder "000000", maxLength 6)
   - "Verify" button
   - Mock verification: accept any 6-digit code as valid
   - On verify: call useAuth().updateVerificationStatus('email_verified')
   - Then call onVerified()

4. State management:
   - showCodeEntry: boolean (toggle between views)
   - code: string
   - isVerifying: boolean
   - error: string | null

5. Resend handler:
   - Show "Code sent!" message briefly
   - Call onResendCode if provided

Styling: Center content, glassmorphic card wrapper, consistent with auth forms.
  </action>
  <verify>npm run build passes. Component renders both views correctly.</verify>
  <done>EmailVerification shows check-email screen, can toggle to code entry, mock-verifies any 6-digit code.</done>
</task>

<task type="auto">
  <name>Task 2: Update AuthModal to include email verification step</name>
  <files>src/components/features/authModal.tsx</files>
  <action>
Extend AuthModal to show email verification after sign-up:

1. Add new view type: 'signUp' | 'signIn' | 'emailVerification'

2. Add local state:
   - pendingEmail: string | null (set after successful sign-up)

3. Update SignUpForm onSuccess handler:
   - Don't close modal immediately
   - Set pendingEmail to the email used
   - Set currentView to 'emailVerification'

4. Add emailVerification view rendering:
   - Render EmailVerification component
   - Pass pendingEmail as email prop
   - onVerified: call props.onSuccess(), close modal

5. Update SignInForm onSuccess:
   - Check user.verificationStatus from useAuth()
   - If 'unverified': switch to emailVerification view
   - If already verified: close modal and call onSuccess

This creates flow: SignUp → EmailVerification → Success (or SignIn → Check status → maybe EmailVerification)
  </action>
  <verify>Sign up, modal switches to email verification. Enter 6 digits, verify, modal closes.</verify>
  <done>AuthModal shows email verification after sign-up, handles verification flow correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Email verification flow in AuthModal</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/deals/deal-1
    3. Click "Create Free Account"
    4. Fill in email (any@example.com), password (8+ chars), confirm password
    5. Click "Sign Up"
    6. Verify: Modal switches to "Check your email" screen
    7. Click "enter verification code manually"
    8. Enter any 6 digits (e.g., 123456)
    9. Click "Verify"
    10. Verify: Modal closes, user is now signed in with email_verified status
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] EmailVerification component shows both views
- [ ] AuthModal transitions to email verification after sign-up
- [ ] Mock verification accepts any 6-digit code
</verification>

<success_criteria>
- EmailVerification component with check-email and code-entry views
- AuthModal shows email verification after sign-up
- Verification updates user status to 'email_verified'
- Flow tested and working
- Ready for 04-04 (SMS verification)
</success_criteria>

<output>
After completion, create `.planning/phases/04-consumer-auth/04-03-SUMMARY.md`
</output>
