---
phase: 04-consumer-auth
plan: 04
type: execute
---

<objective>
Create SMS/phone verification UI flow with mock verification.

Purpose: Build the phone number entry and code verification step for full user verification.
Output: PhoneVerification component, integration with auth flow after email verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/04-consumer-auth/04-01-SUMMARY.md
@.planning/phases/04-consumer-auth/04-02-SUMMARY.md
@.planning/phases/04-consumer-auth/04-03-SUMMARY.md

# Existing patterns:
@src/lib/context/authContext.tsx - Auth context
@src/components/features/authModal.tsx - AuthModal with email verification
@src/components/features/emailVerification.tsx - Email verification pattern
@src/types/consumer.ts - VerificationStatus, Consumer with phone field

**Tech stack available:** AuthContext, Modal, Input, Button
**Established patterns:** Email verification flow pattern
**Constraining decisions:**
- Mock SMS only (no real SMS sending)
- VerificationStatus progression: 'email_verified' → 'phone_verified' (or 'fully_verified' if both done)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhoneVerification component</name>
  <files>src/components/features/phoneVerification.tsx</files>
  <action>
Create 'use client' component for phone verification UI:

1. Props interface:
   - onVerified?: () => void
   - onSkip?: () => void (optional skip for MVP)

2. Two-step UI:

Step 1 - Phone number entry:
   - Phone icon (Phone from Phosphor)
   - "Verify your phone" heading
   - "Add your phone number to secure your account" subtext
   - Phone input (type="tel", placeholder "+1 (555) 000-0000")
   - Basic phone format validation (10+ digits)
   - "Send Code" button
   - "Skip for now" link (calls onSkip)

Step 2 - Code verification:
   - "Enter verification code" heading
   - "We sent a 6-digit code to {phoneNumber}" subtext
   - 6 digit code input (single Input, maxLength 6)
   - "Verify" button
   - "Didn't receive code? Resend" link
   - "Use different number" link (goes back to step 1)

3. State management:
   - step: 'phone' | 'code'
   - phoneNumber: string
   - code: string
   - isSubmitting: boolean
   - error: string | null

4. Verification logic:
   - Send code: store phone, switch to code step
   - Verify: accept any 6-digit code
   - On verify: call useAuth() to update phone number AND verification status
   - Need to add setPhone method to authContext

5. Styling: Match EmailVerification component styling.
  </action>
  <verify>npm run build passes. Component renders both steps correctly.</verify>
  <done>PhoneVerification handles phone entry and code verification with mock logic.</done>
</task>

<task type="auto">
  <name>Task 2: Add phone update method to AuthContext</name>
  <files>src/lib/context/authContext.tsx</files>
  <action>
Add method to update user's phone and verification status:

1. Add to AuthContextValue interface:
   - verifyPhone: (phone: string) => void

2. Implement verifyPhone:
   - Update user.phone with provided number
   - Update user.phoneVerifiedAt with current ISO timestamp
   - Update verificationStatus:
     - If currently 'email_verified': set to 'fully_verified'
     - If currently 'unverified': set to 'phone_verified'
   - Persist to localStorage

This allows PhoneVerification to complete the verification flow.
  </action>
  <verify>TypeScript compiles. verifyPhone available from useAuth().</verify>
  <done>AuthContext has verifyPhone method that updates phone and verification status.</done>
</task>

<task type="auto">
  <name>Task 3: Update AuthModal to include phone verification step</name>
  <files>src/components/features/authModal.tsx</files>
  <action>
Extend AuthModal to show phone verification after email verification:

1. Add new view: 'phoneVerification' to view types

2. Update email verification onVerified handler:
   - Don't close modal yet
   - Switch to 'phoneVerification' view

3. Add phoneVerification view rendering:
   - Render PhoneVerification component
   - onVerified: call props.onSuccess(), close modal
   - onSkip: call props.onSuccess(), close modal (user can verify phone later)

Flow becomes: SignUp → EmailVerification → PhoneVerification → Success

4. For SignIn flow:
   - If user is 'email_verified' but not 'fully_verified': show phone verification
   - If user is 'fully_verified': close modal directly
  </action>
  <verify>Complete full sign-up flow through phone verification. Verify user status is 'fully_verified'.</verify>
  <done>AuthModal includes phone verification step, full verification flow works end-to-end.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] PhoneVerification handles phone entry and code verification
- [ ] AuthContext.verifyPhone updates phone and status
- [ ] AuthModal shows phone verification after email verification
- [ ] Skip option available for phone verification
</verification>

<success_criteria>
- PhoneVerification component with phone entry and code views
- AuthContext has verifyPhone method
- AuthModal shows phone verification after email verification
- Full flow: SignUp → Email → Phone → Success
- Skip option works for phone verification
- Ready for 04-05 (business reveal)
</success_criteria>

<output>
After completion, create `.planning/phases/04-consumer-auth/04-04-SUMMARY.md`
</output>
