---
phase: 04-consumer-auth
plan: 05
type: execute
---

<objective>
Implement business reveal on verification - show business details to authenticated users.

Purpose: Complete the "anonymous until committed" flow by revealing business info after auth.
Output: Updated deal detail page showing business info for verified users, BusinessInfo component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/04-consumer-auth/04-01-SUMMARY.md
@.planning/phases/04-consumer-auth/04-02-SUMMARY.md
@.planning/phases/04-consumer-auth/04-03-SUMMARY.md
@.planning/phases/04-consumer-auth/04-04-SUMMARY.md

# Existing code:
@src/lib/context/authContext.tsx - Auth context with verification status
@src/components/features/claimCTA.tsx - Current auth wall component
@src/app/deals/[id]/page.tsx - Deal detail page
@src/types/deal.ts - Deal and AnonymousDeal types
@src/types/business.ts - Business type
@src/lib/mock-data/deals.ts - getDealById returns full Deal
@src/lib/mock-data/businesses.ts - Business data

**Tech stack available:** AuthContext with verification status
**Established patterns:** Auth wall in ClaimCTA, glassmorphic cards
**Constraining decisions:**
- Business details revealed only to verified users (email_verified, phone_verified, or fully_verified)
- AnonymousDeal hides businessId, shows area instead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BusinessInfo component</name>
  <files>src/components/features/businessInfo.tsx</files>
  <action>
Create component to display revealed business information:

1. Props interface:
   - business: Business (from types)
   - deal: Deal (for context)

2. UI structure in a Card:
   - Business name (large, prominent)
   - Verified badge if business.tier is 'paid'
   - Address: business.address, business.city, business.state
   - Phone: business.phone (clickable tel: link)
   - Website: business.website (clickable link, opens new tab)
   - Hours: business.hours (if available)
   - Rating: business.rating with star display

3. "Claim This Deal" button (primary, full width)
   - For now, just shows alert/toast "Claim flow coming in Phase 5"

4. Styling:
   - Glassmorphic Card with padding="lg"
   - Business name as text-xl font-semibold
   - Contact info with icons (Phone, Globe, MapPin, Clock from Phosphor)
   - Match the existing ClaimCTA card styling for consistency
  </action>
  <verify>npm run build passes. Component renders business info correctly.</verify>
  <done>BusinessInfo displays business name, contact, address, and claim button.</done>
</task>

<task type="auto">
  <name>Task 2: Add business query utility</name>
  <files>src/lib/mock-data/utils.ts</files>
  <action>
Add function to get business by ID:

1. Import Business type and businesses array

2. Export getBusinessById(businessId: string): Business | null
   - Find business in businesses array by id
   - Return business or null if not found

This allows deal detail page to fetch business data when user is authenticated.
  </action>
  <verify>Import works: import { getBusinessById } from '@/lib/mock-data'</verify>
  <done>getBusinessById utility available for fetching business data.</done>
</task>

<task type="auto">
  <name>Task 3: Update deal detail page with conditional business reveal</name>
  <files>src/app/deals/[id]/page.tsx</files>
  <action>
Modify deal detail page to show business info to verified users:

1. The page is a Server Component, but auth state is client-side.
   Create a new client component: src/components/features/dealSidebar.tsx

2. DealSidebar component:
   - Props: deal: Deal
   - Uses useAuth() to check authentication state
   - Conditional rendering:
     - If NOT authenticated OR verificationStatus is 'unverified':
       Show ClaimCTA (current behavior)
     - If authenticated AND verified (email_verified, phone_verified, or fully_verified):
       Fetch business using getBusinessById(deal.businessId)
       Show BusinessInfo component with business and deal

3. Update page.tsx:
   - Import DealSidebar
   - Replace ClaimCTA with DealSidebar in the sidebar column
   - Pass full Deal (not AnonymousDeal) to DealSidebar
   - Note: getDealById already returns full Deal, just use it

4. The main content still shows anonymous info (treatment, pricing, area) - that doesn't change.
   Only the sidebar reveals business details.
  </action>
  <verify>npm run build passes. Page renders correctly for both anonymous and authenticated states.</verify>
  <done>Deal detail page shows ClaimCTA for anonymous users, BusinessInfo for verified users.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full authentication and business reveal flow</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/deals/deal-1
    3. Verify: Sidebar shows "Business Details Hidden" with auth wall
    4. Click "Create Free Account"
    5. Complete sign-up flow (email, password, email verification with any 6 digits)
    6. Complete or skip phone verification
    7. Verify: Modal closes, sidebar now shows:
       - Business name (e.g., "Austin Aesthetics")
       - Address, phone, website
       - "Claim This Deal" button
    8. Refresh page - verify business info persists (localStorage auth)
    9. Open dev tools > Application > Local Storage > clear costfinders_auth
    10. Refresh - verify auth wall returns
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] BusinessInfo component shows business details
- [ ] DealSidebar conditionally shows ClaimCTA or BusinessInfo
- [ ] Business reveal works for verified users
- [ ] Auth persistence works across page refresh
</verification>

<success_criteria>
- BusinessInfo component displays business details
- getBusinessById utility available
- Deal detail page reveals business to verified users
- Anonymous users still see auth wall
- Full flow tested end-to-end
- Phase 4 complete, ready for Phase 5 (Consumer Dashboard)
</success_criteria>

<output>
After completion, create `.planning/phases/04-consumer-auth/04-05-SUMMARY.md`:

Mark Phase 4 complete in summary. Note:
- AuthContext pattern established
- Sign-up, sign-in, email verification, phone verification flows
- Business reveal implemented
- Ready for Phase 5 to add favorites, claim flow, status tracking
</output>
