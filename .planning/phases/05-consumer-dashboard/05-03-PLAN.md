---
phase: 05-consumer-dashboard
plan: 03
type: execute
---

<objective>
Implement the claim deal flow with claims context and modal form.

Purpose: Allow consumers to claim deals by submitting preferred date/time and optional notes.
Output: Claims context for state management, ClaimDealModal component, integration with deal detail ClaimCTA.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-consumer-dashboard/05-02-SUMMARY.md

**Tech stack available:** AuthContext pattern, Modal component, Input/Button/Card components
**Established patterns:** Context with localStorage, form validation, modal view switching
**Key files:**
@src/types/claim.ts
@src/lib/mock-data/consumers.ts
@src/components/features/claimCTA.tsx
@src/app/deals/[id]/page.tsx

**Constraining decisions:**
- Claim type: id, dealId, consumerId, businessId, status, preferredDate, preferredTime, notes
- ClaimStatus: pending, contacted, booked, completed, cancelled, expired
- ClaimCTA currently triggers AuthModal for unauthenticated users
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create claims context for managing claim state</name>
  <files>src/lib/context/claimsContext.tsx, src/app/layout.tsx</files>
  <action>
Create ClaimsContext following AuthContext pattern:

1. Create `src/lib/context/claimsContext.tsx`:
   - ClaimsState: claims (Claim[]), isLoading (boolean)
   - ClaimsContextValue: state, createClaim, getClaim, getClaimsByStatus
   - createClaim: (dealId, businessId, preferredDate?, preferredTime?, notes?) => Claim
     - Generate unique ID: `claim-${Date.now()}`
     - Set status: 'pending'
     - Set consumerId from AuthContext user
     - Calculate expiresAt: 7 days from now
     - Persist to localStorage: 'costfinders_claims'
   - Load claims from localStorage on mount
   - Filter to only show current user's claims

2. Add ClaimsProvider to `src/app/layout.tsx`:
   - Wrap inside AuthProvider (needs auth context)

3. Export useClaims hook

Integration with mock data: Claims from consumers.ts are fixture data. ClaimsContext manages user-created claims separately.
  </action>
  <verify>TypeScript compiles, useClaims hook exports createClaim method</verify>
  <done>ClaimsContext provides claim state management with localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 2: Create ClaimDealModal component</name>
  <files>src/components/features/claimDealModal.tsx</files>
  <action>
Create modal for claiming a deal:

1. Props:
   - isOpen (boolean)
   - onClose () => void
   - dealId (string)
   - businessId (string)
   - dealTitle (string)

2. Modal content:
   - Header: "Claim This Deal"
   - Deal title display
   - Form fields:
     - Preferred Date (date input, optional)
     - Preferred Time (select: Morning, Afternoon, Evening, Flexible - optional)
     - Notes/Message (textarea, optional, max 500 chars)
   - Submit button: "Submit Claim"
   - Cancel button

3. On submit:
   - Call createClaim from ClaimsContext
   - Show success state with checkmark
   - Display: "Claim submitted! The business will contact you soon."
   - Close button or auto-close after 3 seconds

4. Validation:
   - No required fields (all optional preferences)
   - If date provided, must be in future

Use existing Modal, Input, Button components. Match form styling from SignUpForm.
  </action>
  <verify>ClaimDealModal renders with form, submits claim, shows success state</verify>
  <done>ClaimDealModal component handles full claim flow with success feedback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate claim modal into deal detail page</name>
  <files>src/components/features/claimCTA.tsx, src/app/deals/[id]/page.tsx</files>
  <action>
Connect ClaimDealModal to the deal detail flow:

1. Modify `src/components/features/claimCTA.tsx`:
   - Add state for ClaimDealModal visibility
   - When user is authenticated and verified:
     - "Claim This Deal" button opens ClaimDealModal instead of just showing message
   - Pass dealId, businessId, dealTitle to modal
   - Get businessId from deal data (need to pass as prop or fetch)

2. Update `src/app/deals/[id]/page.tsx`:
   - Pass businessId to ClaimCTA (from getDealById which returns full Deal with businessId)
   - Already passes dealId and title

3. Flow:
   - Anonymous user clicks CTA → AuthModal opens
   - User signs up/in and verifies → Modal closes, can now claim
   - Verified user clicks CTA → ClaimDealModal opens
   - User submits claim → Success message
   - User can go to /dashboard/claims to see their claims (next plan)

Handle edge case: User already claimed this deal → Show "Already Claimed" state.
  </action>
  <verify>Clicking Claim CTA as verified user opens claim modal, submitting creates claim</verify>
  <done>Claim flow works end-to-end from deal detail through modal submission</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete claim deal flow with modal and context</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Sign in as verified user (sarah@example.com - fully_verified)
    3. Go to any deal detail page: /deals/deal-1
    4. Click "Claim This Deal" button
    5. Verify: ClaimDealModal opens with form
    6. Fill optional fields and submit
    7. Verify: Success message displays
    8. Refresh and try to claim same deal - should show "Already Claimed"
    9. Check localStorage for costfinders_claims - claim should be stored
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] ClaimsContext properly manages claim state
- [ ] ClaimDealModal form works correctly
- [ ] Claims persist to localStorage
- [ ] Already-claimed deals show appropriate state
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Claim flow is intuitive and provides clear feedback
- Claims persist across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/05-consumer-dashboard/05-03-SUMMARY.md`
</output>
